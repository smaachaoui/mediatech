{% extends 'base.html.twig' %}

{% block title %}Catalogue | MediaTech{% endblock %}

{% block body %}

<div class="d-flex flex-column gap-3">

  <section class="bg-white border rounded-3 p-3">
    <h1 class="h5 mb-3 text-center">Vous cherchez un livre ou un film ?</h1>

    <form method="get" action="{{ path('app_catalog') }}" class="row g-2 align-items-center">
      <div class="col-12 col-md">
        <div class="input-group">
          <span class="input-group-text" aria-hidden="true">üîé</span>
          <input
            type="search"
            name="q"
            value="{{ q|default('') }}"
            class="form-control"
            placeholder="Titre, auteur, r√©alisateur..."
          >
        </div>
      </div>

      <input type="hidden" name="type" value="{{ type|default('all') }}">

      <div class="col-12 col-md-auto">
        <button class="btn btn-primary w-100" type="submit">Rechercher</button>
      </div>
    </form>
  </section>

  <section class="bg-white border rounded-3 p-3">
    <div class="row g-4">

      <aside class="col-12 col-lg-3">
        <div class="border rounded-3 p-3">
          <h2 class="h6 mb-3">Filtrer</h2>

          <form method="get" action="{{ path('app_catalog') }}">
            <div class="mb-3">
              <label class="form-label">Type</label>
              <select class="form-select" name="type">
                <option value="all" {{ type == 'all' ? 'selected' : '' }}>Tout</option>
                <option value="book" {{ type == 'book' ? 'selected' : '' }}>Livres</option>
                <option value="movie" {{ type == 'movie' ? 'selected' : '' }}>Films</option>
              </select>
            </div>

            {% if q is defined and q %}
              <input type="hidden" name="q" value="{{ q }}">
            {% endif %}

            <div class="d-grid gap-2">
              <button class="btn btn-dark" type="submit">Appliquer</button>
              <a class="btn btn-outline-secondary" href="{{ path('app_catalog') }}">R√©initialiser</a>
            </div>
          </form>
        </div>
      </aside>

      <div class="col-12 col-lg-9">

        {% set books = books|default([]) %}
        {% set movies = movies|default([]) %}
        {% set hasAny = (books|length) + (movies|length) > 0 %}

        {% if not hasAny %}
          {% include 'components/_state_empty.html.twig' with {
            title: q ? 'Aucun r√©sultat' : 'Catalogue',
            message: q ? 'Essayez de modifier vos filtres ou votre recherche.' : 'Aucun √©l√©ment √† afficher pour le moment.'
          } %}

        {% else %}

          {% if type == 'all' %}
            {% if books is not empty %}
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="h6 mb-0">Livres</h3>
                {% if q %}
                  <a href="{{ path('app_catalog', { q: q, type: 'book' }) }}" class="btn btn-outline-primary btn-sm">
                    Voir tous les livres
                  </a>
                {% else %}
                  <a href="{{ path('app_catalog', { type: 'book' }) }}" class="btn btn-outline-primary btn-sm">
                    Voir tous les livres
                  </a>
                {% endif %}
              </div>

              <div class="row g-3 mb-4">
                {% for book in books %}
                  <div class="col-6 col-md-4 col-lg-3">
                    {% include 'components/_structure_media.html.twig' with { item: book, kind: 'book' } only %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% if movies is not empty %}
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="h6 mb-0">Films</h3>
                {% if q %}
                  <a href="{{ path('app_catalog', { q: q, type: 'movie' }) }}" class="btn btn-outline-primary btn-sm">
                    Voir tous les films
                  </a>
                {% else %}
                  <a href="{{ path('app_catalog', { type: 'movie' }) }}" class="btn btn-outline-primary btn-sm">
                    Voir tous les films
                  </a>
                {% endif %}
              </div>

              <div class="row g-3">
                {% for movie in movies %}
                  <div class="col-6 col-md-4 col-lg-3">
                    {% include 'components/_structure_media.html.twig' with { item: movie, kind: 'movie' } only %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

          {% elseif type == 'book' %}
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h6 mb-0">Livres</h3>
              {% if totalBooks is defined and totalBooks > 0 %}
                <span class="text-muted small">{{ totalBooks }} r√©sultat{{ totalBooks > 1 ? 's' : '' }}</span>
              {% endif %}
            </div>

            {% if books is empty %}
              <div class="text-muted small mb-4">Aucun livre trouv√©.</div>
            {% else %}
              <div class="row g-3 mb-4">
                {% for book in books %}
                  <div class="col-6 col-md-4 col-lg-3">
                    {% include 'components/_structure_media.html.twig' with { item: book, kind: 'book' } only %}
                  </div>
                {% endfor %}
              </div>

              {% if totalPages > 1 %}
                {% include 'components/_nav_pagination.html.twig' with {
                  route: 'app_catalog',
                  page: page,
                  totalPages: totalPages,
                  query: q ? { type: 'book', q: q } : { type: 'book' }
                } %}
              {% endif %}
            {% endif %}

          {% else %}
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h6 mb-0">Films</h3>
              {% if totalMovies is defined and totalMovies > 0 %}
                <span class="text-muted small">{{ totalMovies }} r√©sultat{{ totalMovies > 1 ? 's' : '' }}</span>
              {% endif %}
            </div>

            {% if movies is empty %}
              <div class="text-muted small">Aucun film trouv√©.</div>
            {% else %}
              <div class="row g-3 mb-4">
                {% for movie in movies %}
                  <div class="col-6 col-md-4 col-lg-3">
                    {% include 'components/_structure_media.html.twig' with { item: movie, kind: 'movie' } only %}
                  </div>
                {% endfor %}
              </div>

              {% if totalPages > 1 %}
                {% include 'components/_nav_pagination.html.twig' with {
                  route: 'app_catalog',
                  page: page,
                  totalPages: totalPages,
                  query: q ? { type: 'movie', q: q } : { type: 'movie' }
                } %}
              {% endif %}
            {% endif %}
          {% endif %}

        {% endif %}

      </div>
    </div>
  </section>

</div>

{% endblock %}