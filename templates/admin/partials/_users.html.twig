{# templates/admin/_users.html.twig #}

<div class="d-flex justify-content-between align-items-start gap-3 mb-3">
  <div>
    <h1 class="h3 mb-1">Utilisateurs</h1>
    <div class="text-muted">Gestion des comptes utilisateurs de la plateforme.</div>
  </div>
</div>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'all' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'all', q: search }) }}">
      Tous
    </a>
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'active' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'active', q: search }) }}">
      Actifs
    </a>
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'inactive' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'inactive', q: search }) }}">
      Inactifs
    </a>
  </div>

  <form method="get" action="{{ path('admin_users_index') }}" class="d-flex gap-2">
    <input type="hidden" name="status" value="{{ filter }}">
    <input type="text"
           name="q"
           class="form-control form-control-sm"
           placeholder="Rechercher..."
           value="{{ search }}"
           style="min-width: 200px;">
    <button type="submit" class="btn btn-outline-primary btn-sm">Rechercher</button>
  </form>
</div>

<div class="card border rounded-3">
  <div class="card-body">

    {% if users is not defined or users is empty %}
      {% include 'components/_state_empty.html.twig' with {
        title: 'Aucun utilisateur',
        message: 'Aucun utilisateur ne correspond à vos critères de recherche.'
      } only %}
    {% else %}
      {% set me = app.user %}

      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="text-muted small">
              <th>Utilisateur</th>
              <th>Email</th>
              <th>Inscrit le</th>
              <th>Statut</th>
              <th>Rôle</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for user in users %}
              {% set isSelf = me and (me.id == user.id) %}
              {% set isAdmin = 'ROLE_ADMIN' in user.roles %}

              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="mt-avatar mt-avatar--sm">
                      {% if user.profilePicture %}
                        <img src="{{ asset(user.profilePicture) }}" alt="" class="mt-avatar__img">
                      {% else %}
                        <div class="mt-avatar__fallback small">
                          {{ user.pseudo|slice(0, 1)|upper }}
                        </div>
                      {% endif %}
                    </div>
                    <div class="fw-semibold">{{ user.pseudo }}</div>
                  </div>
                </td>

                <td class="text-muted">{{ user.email }}</td>

                <td class="text-muted small">
                  {{ user.createdAt ? user.createdAt|date('d/m/Y') : '—' }}
                </td>

                <td>
                  {% if user.isActive %}
                    <span class="badge text-bg-success">Actif</span>
                  {% else %}
                    <span class="badge text-bg-danger">Inactif</span>
                  {% endif %}
                </td>

                <td>
                  {% if isAdmin %}
                    <span class="badge text-bg-primary">Admin</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Membre</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  {% if isSelf %}
                    <span class="text-muted small">Compte courant</span>
                  {% else %}
                    <div class="d-inline-flex gap-2">

                      <button type="button"
                              class="btn btn-outline-secondary btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#toggleStatusModal_{{ user.id }}">
                        {{ user.isActive ? 'Désactiver' : 'Réactiver' }}
                      </button>

                      <button type="button"
                              class="btn btn-outline-primary btn-sm"
                              data-bs-toggle="modal"
                              data-bs-target="#toggleAdminModal_{{ user.id }}">
                        {{ isAdmin ? 'Retirer admin' : 'Promouvoir admin' }}
                      </button>

                    </div>

                    {# Modal Toggle Status #}
                    {% set statusModalBody %}
                      <p>Voulez-vous {{ user.isActive ? 'désactiver' : 'réactiver' }} le compte de <strong>{{ user.pseudo }}</strong> ?</p>
                      {% if user.isActive %}
                        <p class="text-warning mb-0">L'utilisateur ne pourra plus se connecter.</p>
                      {% else %}
                        <p class="text-success mb-0">L'utilisateur pourra à nouveau se connecter.</p>
                      {% endif %}
                    {% endset %}

                    {% set statusModalFooter %}
                      <form method="post" action="{{ path('admin_users_toggle_status', { id: user.id }) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('admin_toggle_user_' ~ user.id) }}">
                        <button type="submit" class="btn {{ user.isActive ? 'btn-warning' : 'btn-success' }}">
                          Confirmer
                        </button>
                      </form>
                    {% endset %}

                    {% include 'components/_modal.html.twig' with {
                      id: 'toggleStatusModal_' ~ user.id,
                      title: user.isActive ? 'Désactiver le compte' : 'Réactiver le compte',
                      body: statusModalBody,
                      footer: statusModalFooter
                    } %}

                    {# Modal Toggle Admin #}
                    {% set adminModalBody %}
                      <p>
                        {% if isAdmin %}
                          Voulez-vous retirer les droits administrateur de <strong>{{ user.pseudo }}</strong> ?
                        {% else %}
                          Voulez-vous promouvoir <strong>{{ user.pseudo }}</strong> au rang d'administrateur ?
                        {% endif %}
                      </p>
                    {% endset %}

                    {% set adminModalFooter %}
                      <form method="post" action="{{ path('admin_users_toggle_admin', { id: user.id }) }}">
                        <input type="hidden" name="_token" value="{{ csrf_token('admin_toggle_admin_' ~ user.id) }}">
                        <button type="submit" class="btn btn-primary">Confirmer</button>
                      </form>
                    {% endset %}

                    {% include 'components/_modal.html.twig' with {
                      id: 'toggleAdminModal_' ~ user.id,
                      title: isAdmin ? 'Retirer les droits administrateur' : 'Promouvoir administrateur',
                      body: adminModalBody,
                      footer: adminModalFooter
                    } %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if totalPages is defined and totalPages > 1 %}
        <div class="mt-3">
          {% include 'components/_nav_pagination.html.twig' with {
            route: 'admin_users_index',
            page: page,
            totalPages: totalPages,
            query: { status: filter, q: search }
          } %}
        </div>
      {% endif %}
    {% endif %}

  </div>
</div>
