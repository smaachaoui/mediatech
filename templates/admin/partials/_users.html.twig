<div class="d-flex justify-content-between align-items-start gap-3 mb-3">
  <div>
    <h1 class="h3 mb-1">Utilisateurs</h1>
    <div class="text-muted">Gestion des comptes utilisateurs de la plateforme.</div>
  </div>
</div>

<div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'all' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'all', q: search }) }}">
      Tous
    </a>
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'active' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'active', q: search }) }}">
      Actifs
    </a>
    <a class="btn btn-outline-secondary btn-sm {{ filter == 'inactive' ? 'active' : '' }}"
       href="{{ path('admin_users_index', { status: 'inactive', q: search }) }}">
      Inactifs
    </a>
  </div>

  <form method="get" action="{{ path('admin_users_index') }}" class="d-flex gap-2">
    <input type="hidden" name="status" value="{{ filter }}">
    <input type="text" 
           name="q" 
           class="form-control form-control-sm" 
           placeholder="Rechercher..." 
           value="{{ search }}"
           style="min-width: 200px;">
    <button type="submit" class="btn btn-outline-primary btn-sm">Rechercher</button>
  </form>
</div>

<div class="card border rounded-3">
  <div class="card-body">

    {% if users is not defined or users is empty %}
      {% include 'components/_state_empty.html.twig' with {
        title: 'Aucun utilisateur',
        message: 'Aucun utilisateur ne correspond à vos critères de recherche.'
      } only %}
    {% else %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="text-muted small">
              <th>Utilisateur</th>
              <th>Email</th>
              <th>Inscrit le</th>
              <th>Statut</th>
              <th>Rôle</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td>
                  <div class="d-flex align-items-center gap-2">
                    <div class="rounded-circle overflow-hidden border bg-light d-flex align-items-center justify-content-center" 
                         style="width: 36px; height: 36px;">
                      {% if user.profilePicture %}
                        <img src="{{ asset(user.profilePicture) }}" alt="" class="w-100 h-100" style="object-fit: cover;">
                      {% else %}
                        <span class="text-muted small">{{ user.pseudo|slice(0, 1)|upper }}</span>
                      {% endif %}
                    </div>
                    <div class="fw-semibold">{{ user.pseudo }}</div>
                  </div>
                </td>

                <td class="text-muted">{{ user.email }}</td>

                <td class="text-muted small">
                  {{ user.createdAt ? user.createdAt|date('d/m/Y') : '—' }}
                </td>

                <td>
                  {% if user.isActive %}
                    <span class="badge text-bg-success">Actif</span>
                  {% else %}
                    <span class="badge text-bg-danger">Inactif</span>
                  {% endif %}
                </td>

                <td>
                  {% if 'ROLE_ADMIN' in user.roles %}
                    <span class="badge text-bg-primary">Admin</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Membre</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  <div class="d-inline-flex gap-2">

                    <button type="button" 
                            class="btn btn-outline-secondary btn-sm"
                            data-bs-toggle="modal" 
                            data-bs-target="#toggleStatusModal_{{ user.id }}">
                      {{ user.isActive ? 'Désactiver' : 'Réactiver' }}
                    </button>

                    {% if 'ROLE_ADMIN' not in user.roles or user.id != app.user.id %}
                      <button type="button" 
                              class="btn btn-outline-primary btn-sm"
                              data-bs-toggle="modal" 
                              data-bs-target="#toggleAdminModal_{{ user.id }}">
                        {{ 'ROLE_ADMIN' in user.roles ? 'Retirer admin' : 'Promouvoir admin' }}
                      </button>
                    {% endif %}

                  </div>

                  {% include 'components/_modal.html.twig' with {
                    id: 'toggleStatusModal_' ~ user.id,
                    title: (user.isActive ? 'Désactiver le compte' : 'Réactiver le compte'),
                    body: '
                      <p>Voulez-vous ' ~ (user.isActive ? 'désactiver' : 'réactiver') ~ ' le compte de <strong>' ~ user.pseudo|e ~ '</strong> ?</p>
                      ' ~ (user.isActive ? '<p class="text-warning mb-0">L\'utilisateur ne pourra plus se connecter.</p>' : '<p class="text-success mb-0">L\'utilisateur pourra à nouveau se connecter.</p>') ~ '
                    ',
                    footer: '
                      <form method="post" action="' ~ path('admin_users_toggle_status', { id: user.id }) ~ '">
                        <input type="hidden" name="_token" value="' ~ csrf_token('admin_toggle_user_' ~ user.id) ~ '">
                        <button type="submit" class="btn ' ~ (user.isActive ? 'btn-warning' : 'btn-success') ~ '">
                          Confirmer
                        </button>
                      </form>
                    '
                  } %}

                  {% include 'components/_modal.html.twig' with {
                    id: 'toggleAdminModal_' ~ user.id,
                    title: ('ROLE_ADMIN' in user.roles ? 'Retirer les droits administrateur' : 'Promouvoir administrateur'),
                    body: '
                      <p>Voulez-vous ' ~ ('ROLE_ADMIN' in user.roles ? 'retirer les droits administrateur de' : 'promouvoir') ~ ' <strong>' ~ user.pseudo|e ~ '</strong> ' ~ ('ROLE_ADMIN' in user.roles ? '' : 'au rang d\'administrateur') ~ ' ?</p>
                    ',
                    footer: '
                      <form method="post" action="' ~ path('admin_users_toggle_admin', { id: user.id }) ~ '">
                        <input type="hidden" name="_token" value="' ~ csrf_token('admin_toggle_admin_' ~ user.id) ~ '">
                        <button type="submit" class="btn btn-primary">
                          Confirmer
                        </button>
                      </form>
                    '
                  } %}

                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if totalPages is defined and totalPages > 1 %}
        <div class="mt-3">
          {% include 'components/_nav_pagination.html.twig' with {
            route: 'admin_users_index',
            page: page,
            totalPages: totalPages,
            query: { status: filter, q: search }
          } %}
        </div>
      {% endif %}
    {% endif %}

  </div>
</div>