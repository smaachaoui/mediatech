<div class="d-flex justify-content-between align-items-start gap-3 mb-3">
  <div>
    <h1 class="h3 mb-1">Collections</h1>
    <div class="text-muted">Gestion des collections utilisateur (publication et visibilité).</div>
  </div>
</div>

<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'all' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'all' }) }}">
    Toutes
  </a>
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'published' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'published' }) }}">
    Publiées
  </a>
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'unpublished' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'unpublished' }) }}">
    Non publiées
  </a>
</div>

<div class="card border rounded-3">
  <div class="card-body">

    {% if collections is empty %}
      <div class="text-muted">Aucune collection.</div>
    {% else %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
          <tr class="text-muted small">
            <th>Nom</th>
            <th>Auteur</th>
            <th>Type</th>
            <th>Éléments</th>
            <th>Statut</th>
            <th class="text-end">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% for c in collections %}
            {% set itemsCount = (c.collectionBooks|length) + (c.collectionMovies|length) %}

            <tr>
              <td class="fw-semibold">
                {{ c.name }}
                <div class="text-muted small">
                  Créée le {{ c.createdAt ? c.createdAt|date('d/m/Y') : '—' }}
                </div>
              </td>

              <td>
                {% if c.user %}
                  {{ c.user.pseudo ?? c.user.email }}
                {% else %}
                  —
                {% endif %}
              </td>

              <td>
                {{ c.mediaType == 'book' ? 'Livres' : (c.mediaType == 'movie' ? 'Films' : 'Mixte') }}
              </td>

              <td>{{ itemsCount }}</td>

              <td>
                {% if c.isPublished %}
                  <span class="badge text-bg-success">Publiée</span>
                {% else %}
                  <span class="badge text-bg-secondary">Privée</span>
                {% endif %}
              </td>

              <td class="text-end">
                <div class="d-inline-flex gap-2">
                  {% if c.isPublished %}
                    <a class="btn btn-outline-secondary btn-sm"
                       href="{{ path('app_collection_show', { id: c.id }) }}">
                      Voir
                    </a>
                  {% endif %}

                  <a class="btn btn-outline-secondary btn-sm"
                     href="{{ path('admin_collections_edit', { id: c.id }) }}">
                    Modifier
                  </a>

                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteCollectionModal_{{ c.id }}">
                    Supprimer
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#togglePublishCollectionModal_{{ c.id }}">
                    {{ c.isPublished ? 'Dépublier' : 'Publier' }}
                  </button>
                </div>

                {% include 'components/_modal.html.twig' with {
                  id: 'deleteCollectionModal_' ~ c.id,
                  title: 'Supprimer la collection',
                  body: '
                    <p>Voulez-vous vraiment supprimer la collection <strong>' ~ c.name|e ~ '</strong> ?</p>
                    <p class="text-danger mb-0">Cette action est définitive.</p>
                  ',
                  footer: '
                    <form method="post" action="' ~ path('admin_collections_delete', { id: c.id }) ~ '">
                      <input type="hidden" name="_token" value="' ~ csrf_token('admin_delete_collection_' ~ c.id) ~ '">
                      <button type="submit" class="btn btn-danger">
                        Supprimer définitivement
                      </button>
                    </form>
                  '
                } %}

                {% include 'components/_modal.html.twig' with {
                  id: 'togglePublishCollectionModal_' ~ c.id,
                  title: (c.isPublished ? 'Dépublier la collection' : 'Publier la collection'),
                  body: '
                    <p>Confirmer la modification de publication pour <strong>' ~ c.name|e ~ '</strong> ?</p>
                  ',
                  footer: '
                    <form method="post" action="' ~ path('admin_collections_toggle_publish', { id: c.id }) ~ '">
                      <input type="hidden" name="_token" value="' ~ csrf_token('admin_toggle_publish_collection_' ~ c.id) ~ '">
                      <button type="submit" class="btn btn-primary">
                        Confirmer
                      </button>
                    </form>
                  '
                } %}

              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if totalPages > 1 %}
        <nav class="mt-3">
          <ul class="pagination mb-0">
            {% for p in 1..totalPages %}
              <li class="page-item {{ p == page ? 'active' : '' }}">
                <a class="page-link"
                   href="{{ path('admin_collections_index', { page: p, published: filter }) }}">
                  {{ p }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </nav>
      {% endif %}
    {% endif %}

  </div>
</div>
