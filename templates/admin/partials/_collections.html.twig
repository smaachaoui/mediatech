<div class="d-flex justify-content-between align-items-start gap-3 mb-3 flex-wrap">
  <div>
    <h1 class="h3 mb-1">Collections</h1>
    <div class="text-muted">Gestion des collections utilisateur (publication et visibilité).</div>
  </div>
</div>

<div class="d-flex flex-wrap gap-2 mb-3">
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'all' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'all' }) }}">
    Toutes
  </a>
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'published' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'published' }) }}">
    Publiées
  </a>
  <a class="btn btn-outline-secondary btn-sm {{ filter == 'unpublished' ? 'active' : '' }}"
     href="{{ path('admin_collections_index', { published: 'unpublished' }) }}">
    Non publiées
  </a>
</div>

<div class="card border rounded-3">
  <div class="card-body">

    {% if collections is empty %}
      <div class="text-muted">Aucune collection.</div>
    {% else %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
          <tr class="text-muted small">
            <th>Nom</th>
            <th class="d-none d-md-table-cell">Auteur</th>
            <th class="d-none d-lg-table-cell">Type</th>
            <th class="d-none d-lg-table-cell">Éléments</th>
            <th>Statut</th>
            <th class="text-end">Actions</th>
          </tr>
          </thead>
          <tbody>
          {% for c in collections %}
            {% set itemsCount = (c.collectionBooks|length) + (c.collectionMovies|length) %}

            <tr>
              <td class="fw-semibold">
                {{ c.name }}
                <div class="text-muted small">
                  Créée le {{ c.createdAt ? c.createdAt|date('d/m/Y') : '—' }}
                </div>
                {# Infos visibles uniquement sur mobile #}
                <div class="d-md-none text-muted small mt-1">
                  Par {{ c.user ? (c.user.pseudo ?? c.user.email) : '—' }}
                </div>
              </td>

              <td class="d-none d-md-table-cell">
                {% if c.user %}
                  {{ c.user.pseudo ?? c.user.email }}
                {% else %}
                  —
                {% endif %}
              </td>

              <td class="d-none d-lg-table-cell">
                {{ c.mediaType == 'book' ? 'Livres' : (c.mediaType == 'movie' ? 'Films' : 'Mixte') }}
              </td>

              <td class="d-none d-lg-table-cell">{{ itemsCount }}</td>

              <td>
                {% if c.isPublished %}
                  <span class="badge text-bg-success">Publiée</span>
                {% else %}
                  <span class="badge text-bg-secondary">Privée</span>
                {% endif %}
              </td>

              <td class="text-end">
                <div class="d-inline-flex gap-2 flex-wrap justify-content-end">
                  {% if c.isPublished %}
                    <a class="btn btn-outline-secondary btn-sm"
                       href="{{ path('app_collection_show', { id: c.id }) }}"
                       target="_blank">
                      <i class="bi bi-eye"></i>
                      <span class="d-none d-sm-inline">Voir</span>
                    </a>
                  {% endif %}

                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#editCollectionModal_{{ c.id }}">
                    <i class="bi bi-pencil"></i>
                    <span class="d-none d-sm-inline">Modifier</span>
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-primary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#togglePublishCollectionModal_{{ c.id }}">
                    <i class="bi bi-{{ c.isPublished ? 'eye-slash' : 'eye' }}"></i>
                    <span class="d-none d-sm-inline">{{ c.isPublished ? 'Dépublier' : 'Publier' }}</span>
                  </button>

                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#deleteCollectionModal_{{ c.id }}">
                    <i class="bi bi-trash"></i>
                    <span class="d-none d-sm-inline">Supprimer</span>
                  </button>
                </div>

                {# MODAL D'ÉDITION (nouvelle) #}
                {% embed 'components/_modal.html.twig' with {
                  id: 'editCollectionModal_' ~ c.id,
                  title: 'Modifier la collection',
                  action: path('admin_collections_update', { id: c.id }),
                  csrf_id: 'admin_edit_collection_' ~ c.id,
                  submit_label: 'Enregistrer',
                  submit_class: 'btn-primary'
                } %}
                  {% block body %}
                    <div class="mb-3">
                      <label class="form-label">Nom</label>
                      <input class="form-control" name="name" type="text" required maxlength="150"
                             value="{{ c.name }}">
                    </div>

                    <div class="mb-3">
                      <label class="form-label">Genre</label>
                      <input type="text" class="form-control" name="genre" value="{{ c.genre ?? '' }}" 
                             placeholder="Fantasy, Action, Romance...">
                    </div>

                    <div class="mb-0">
                      <label class="form-label">Description</label>
                      <textarea class="form-control" name="description" rows="4" maxlength="2000">{{ c.description }}</textarea>
                    </div>
                  {% endblock %}
                {% endembed %}

                {# MODAL DE SUPPRESSION #}
                {% include 'components/_modal.html.twig' with {
                  id: 'deleteCollectionModal_' ~ c.id,
                  title: 'Supprimer la collection',
                  body: '
                    <p>Voulez-vous vraiment supprimer la collection <strong>' ~ c.name|e ~ '</strong> ?</p>
                    <p class="text-danger mb-0">Cette action est définitive.</p>
                  ',
                  footer: '
                    <form method="post" action="' ~ path('admin_collections_delete', { id: c.id }) ~ '">
                      <input type="hidden" name="_token" value="' ~ csrf_token('admin_delete_collection_' ~ c.id) ~ '">
                      <button type="submit" class="btn btn-danger">
                        Supprimer définitivement
                      </button>
                    </form>
                  '
                } %}

                {# MODAL DE PUBLICATION/DÉPUBLICATION #}
                {% include 'components/_modal.html.twig' with {
                  id: 'togglePublishCollectionModal_' ~ c.id,
                  title: (c.isPublished ? 'Dépublier la collection' : 'Publier la collection'),
                  body: '
                    <p>Confirmer la modification de publication pour <strong>' ~ c.name|e ~ '</strong> ?</p>
                  ',
                  footer: '
                    <form method="post" action="' ~ path('admin_collections_toggle_publish', { id: c.id }) ~ '">
                      <input type="hidden" name="_token" value="' ~ csrf_token('admin_toggle_publish_collection_' ~ c.id) ~ '">
                      <button type="submit" class="btn btn-primary">
                        Confirmer
                      </button>
                    </form>
                  '
                } %}

              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if totalPages is defined and totalPages > 1 %}
        <div class="mt-3">
          {% include 'components/_nav_pagination.html.twig' with {
            route: 'admin_collections_index',
            page: page,
            totalPages: totalPages,
            query: { published: filter }
          } %}
        </div>
      {% endif %}
    {% endif %}

  </div>
</div>