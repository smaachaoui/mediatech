<div class="d-flex justify-content-between align-items-start gap-3 mb-3">
  <div>
    <h1 class="h3 mb-1">Commentaires</h1>
    <div class="text-muted">Modération des commentaires publiés sur les collections.</div>
  </div>
</div>

<div class="card border rounded-3">
  <div class="card-body">

    {% if comments is not defined or comments is empty %}
      {% include 'components/_state_empty.html.twig' with {
        title: 'Aucun commentaire',
        message: 'Il n\'y a pas encore de commentaires à modérer.'
      } only %}
    {% else %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="text-muted small">
              <th>Auteur</th>
              <th>Commentaire</th>
              <th>Collection</th>
              <th>Date</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for comment in comments %}
              <tr>
                <td>
                  {% if comment.user %}
                    <div class="fw-semibold">{{ comment.user.pseudo }}</div>
                    <div class="text-muted small">{{ comment.user.email }}</div>
                  {% else %}
                    <div class="fw-semibold">{{ comment.guestName ?? 'Invité' }}</div>
                    <div class="text-muted small">{{ comment.guestEmail ?? '—' }}</div>
                    <span class="badge text-bg-secondary">Invité</span>
                  {% endif %}
                </td>

                <td style="max-width: 300px;">
                  <div class="text-truncate" title="{{ comment.content|e('html_attr') }}">
                    {{ comment.content|length > 100 ? comment.content|slice(0, 100) ~ '...' : comment.content }}
                  </div>
                </td>

                <td>
                  {% if comment.collection %}
                    <a href="{{ path('app_collection_show', { id: comment.collection.id }) }}" 
                       class="text-decoration-none">
                      {{ comment.collection.name|length > 30 ? comment.collection.name|slice(0, 30) ~ '...' : comment.collection.name }}
                    </a>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <td class="text-muted small">
                  {{ comment.createdAt ? comment.createdAt|date('d/m/Y H:i') : '—' }}
                </td>

                <td class="text-end">
                  <button type="button" 
                          class="btn btn-outline-danger btn-sm"
                          data-bs-toggle="modal" 
                          data-bs-target="#deleteCommentModal_{{ comment.id }}">
                    Supprimer
                  </button>

                  {% include 'components/_modal.html.twig' with {
                    id: 'deleteCommentModal_' ~ comment.id,
                    title: 'Supprimer le commentaire',
                    body: '
                      <p>Voulez-vous vraiment supprimer ce commentaire ?</p>
                      <div class="bg-light border rounded p-2 small">
                        ' ~ comment.content|e ~ '
                      </div>
                      <p class="text-danger small mt-2 mb-0">Cette action est définitive.</p>
                    ',
                    footer: '
                      <form method="post" action="' ~ path('admin_comments_delete', { id: comment.id }) ~ '">
                        <input type="hidden" name="_token" value="' ~ csrf_token('admin_delete_comment_' ~ comment.id) ~ '">
                        <button type="submit" class="btn btn-danger">
                          Supprimer définitivement
                        </button>
                      </form>
                    '
                  } %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if totalPages is defined and totalPages > 1 %}
        <div class="mt-3">
          {% include 'components/_nav_pagination.html.twig' with {
            route: 'admin_comments_index',
            page: page,
            totalPages: totalPages,
            query: {}
          } %}
        </div>
      {% endif %}
    {% endif %}

  </div>
</div>