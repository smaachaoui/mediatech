{# templates/components/_structure_collection_grid.html.twig #}
{# Je recois :
   - collection: App\Entity\Collection
   - context: 'public'|'profile' (optionnel)
   - showOwner: bool (optionnel)
   - showActions: bool (optionnel)
   - showVisibilityBadge: bool (optionnel)
#}

{% set context = context ?? 'public' %}
{% set showOwner = showOwner ?? (context == 'public') %}
{% set showActions = showActions ?? (context == 'profile') %}
{% set showVisibilityBadge = showVisibilityBadge ?? true %}

{% set mediaType = collection.mediaType ?? 'all' %}
{% set showPath = path('app_collection_show', { id: collection.id }) %}

{% set typeLabel = 'Mixte' %}
{% if mediaType == 'book' %}
  {% set typeLabel = 'Livres' %}
{% elseif mediaType == 'movie' %}
  {% set typeLabel = 'Films' %}
{% endif %}

{# Je recupere les couvertures des medias de la collection (max 4) #}
{% set mediaCovers = [] %}

{% for link in collection.collectionBooks|slice(0, 4) %}
  {% if link.book and link.book.coverImage %}
    {% set mediaCovers = mediaCovers|merge([link.book.coverImage]) %}
  {% endif %}
{% endfor %}

{% for link in collection.collectionMovies|slice(0, 4 - mediaCovers|length) %}
  {% if link.movie and link.movie.poster %}
    {% set posterUrl = link.movie.poster %}
    {% if not (posterUrl starts with 'http') %}
      {% set posterUrl = 'https://image.tmdb.org/t/p/w500' ~ posterUrl %}
    {% endif %}
    {% set mediaCovers = mediaCovers|merge([posterUrl]) %}
  {% endif %}
{% endfor %}

{% set coversCount = mediaCovers|length %}
{% set itemsCount = (collection.collectionBooks|length) + (collection.collectionMovies|length) %}

{% set ratingCount = collection.ratings is defined ? (collection.ratings|length) : 0 %}
{% set ratingAvg = null %}
{% if ratingCount > 0 %}
  {% set sum = 0 %}
  {% for r in collection.ratings %}
    {% set sum = sum + (r.value ?? 0) %}
  {% endfor %}
  {% set ratingAvg = (sum / ratingCount) %}
{% endif %}

<div class="card h-100 border rounded-3 overflow-hidden">

  <a href="{{ showPath }}" class="text-decoration-none">
    <div class="collection-covers-grid collection-covers-{{ coversCount > 4 ? 4 : coversCount }} bg-light">
      {% if coversCount > 0 %}
        {% for cover in mediaCovers|slice(0, 4) %}
          <div class="collection-cover-item">
            <img src="{{ cover }}" alt="" class="collection-cover-img">
          </div>
        {% endfor %}
      {% else %}
        <div class="collection-cover-empty-full d-flex align-items-center justify-content-center text-muted small">
          <div class="text-center">
            <i class="bi bi-collection fs-1 d-block mb-2"></i>
            Collection vide
          </div>
        </div>
      {% endif %}
    </div>
  </a>

  <div class="card-body d-flex flex-column">

    <div class="d-flex justify-content-between align-items-start gap-2">
      <a href="{{ showPath }}" class="text-decoration-none">
        <div class="fw-semibold text-dark"
             style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
          {{ collection.name }}
        </div>
      </a>

      {% if showVisibilityBadge %}
        {% include 'components/_ui_badge_visibility.html.twig' with { collection: collection } %}
      {% endif %}
    </div>

    {% if showOwner and collection.user %}
      <div class="small text-muted mt-1">
        Par {{ collection.user.pseudo ?? collection.user.email }}
      </div>
    {% endif %}

    {% if collection.description %}
      <div class="small text-muted mt-2"
           style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
        {{ collection.description }}
      </div>
    {% else %}
      <div class="small text-muted mt-2">
        Description : —
      </div>
    {% endif %}

    {% if collection.genre %}
      <div class="small text-muted mt-2">Genre : {{ collection.genre }}</div>
    {% endif %}

    <div class="small text-muted mt-3">
      Type : {{ typeLabel }}
      <span class="mx-1">•</span>
      Contenus : {{ itemsCount }}
    </div>

    <div class="small text-muted mt-1">
      {% if ratingAvg is not null %}
        Note : {{ ratingAvg|number_format(1, '.', ' ') }}/5
        <span class="mx-1">•</span>
        Avis : {{ ratingCount }}
      {% else %}
        Note : —
        <span class="mx-1">•</span>
        Avis : 0
      {% endif %}
    </div>

    <div class="mt-auto d-flex justify-content-between align-items-center pt-3">
      <span class="badge text-bg-light border">{{ typeLabel }}</span>
      <a href="{{ showPath }}" class="btn btn-outline-primary btn-sm">
        Voir la collection
      </a>
    </div>

    {% if showActions %}
      <div class="pt-2 d-flex gap-2">
        {# Je laisse volontairement ces actions neutres pour l'instant #}
      </div>
    {% endif %}

  </div>
</div>