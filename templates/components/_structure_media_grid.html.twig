{# templates/components/_structure_media_grid.html.twig #}
{% set isBook = (kind == 'book') %}

{% if isBook %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.thumbnail %}
  {% set authors = item.authors ?? [] %}
  {% set authorLine = authors is not empty ? authors|join(', ') : 'Auteur inconnu' %}
  {% set year = item.publishedDate ? item.publishedDate|slice(0, 4) : null %}
  {% set metaLine = year ? (authorLine ~ ' - ' ~ year) : authorLine %}
  {% set showPath = path('app_book_show', { id: id }) %}
  {% set mediaLabel = 'Livre' %}
{% else %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.poster %}
  {% set year = item.releaseDate ? item.releaseDate|slice(0, 4) : null %}
  {% set metaLine = year ? ('Sortie : ' ~ year) : 'Sortie inconnue' %}
  {% set showPath = path('app_movie_show', { id: id }) %}
  {% set mediaLabel = 'Film' %}
{% endif %}

{% set addPath = path('app_media_add_to_default', { kind: kind, id: id }) %}
{% set wishlistPath = path('app_media_add_to_wishlist', { kind: kind, id: id }) %}

{% set tokenId = 'add_media_' ~ kind ~ '_' ~ id %}
{% set wishlistTokenId = 'add_wishlist_' ~ kind ~ '_' ~ id %}

<div class="card h-100 border rounded-3 overflow-hidden">

  <a href="{{ showPath }}" class="text-decoration-none">
    {% if imageUrl %}
      <img src="{{ imageUrl }}" class="card-img-top" alt="{{ title }}">
    {% else %}
      <div class="d-flex align-items-center justify-content-center bg-light" style="height: 220px;">
        <div class="text-center px-2">
          <div class="fw-semibold text-muted">Aucune image</div>
          <div class="small text-muted">({{ isBook ? 'couverture' : 'affiche' }})</div>
        </div>
      </div>
    {% endif %}
  </a>

  <div class="card-body d-flex flex-column">

    <a href="{{ showPath }}" class="text-decoration-none">
      <div class="fw-semibold text-dark"
           style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
        {{ title }}
      </div>
    </a>

    <div class="small text-muted mt-1 mb-2"
         style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
      {{ metaLine }}
    </div>

    <div class="mt-auto pt-2">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="badge text-bg-light border">{{ mediaLabel }}</span>
      </div>

      <div class="d-grid gap-2">
        {% if app.user %}
          <form method="post" action="{{ addPath }}">
            <input type="hidden" name="_token" value="{{ csrf_token(tokenId) }}">
            <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
            <button type="submit" class="btn btn-primary btn-sm w-100">
              Ajouter a ma collection
            </button>
          </form>

          <form method="post" action="{{ wishlistPath }}">
            <input type="hidden" name="_token" value="{{ csrf_token(wishlistTokenId) }}">
            <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
            <button type="submit" class="btn btn-outline-primary btn-sm w-100">
              Ajouter a ma liste d'envie
            </button>
          </form>
        {% else %}
          <a href="{{ path('app_login') }}" 
             class="btn btn-primary btn-sm w-100"
             title="Vous devez etre connecte pour ajouter ce media a votre collection">
            Ajouter a ma collection
          </a>

          <a href="{{ path('app_login') }}" 
             class="btn btn-outline-primary btn-sm w-100"
             title="Vous devez etre connecte pour ajouter ce media a votre liste d'envie">
            Ajouter a ma liste d'envie
          </a>
        {% endif %}

        <a href="{{ showPath }}" class="btn btn-outline-secondary btn-sm w-100">
          Voir plus
        </a>
      </div>

    </div>

  </div>
</div>