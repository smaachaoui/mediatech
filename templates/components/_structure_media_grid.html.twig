{% set isBook = (kind == 'book') %}

{% if isBook %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.thumbnail %}
  {% set authors = item.authors ?? [] %}
  {% set authorLine = authors is not empty ? authors|join(', ') : 'Auteur inconnu' %}
  {% set year = item.publishedDate ? item.publishedDate|slice(0, 4) : null %}
  {% set metaLine = year ? (authorLine ~ ' - ' ~ year) : authorLine %}
  {% set showPath = path('app_book_show', { id: id }) %}
  {% set mediaLabel = 'Livre' %}
{% else %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.poster %}
  {% set year = item.releaseDate ? item.releaseDate|slice(0, 4) : null %}
  {% set metaLine = year ? ('Sortie : ' ~ year) : 'Sortie inconnue' %}
  {% set showPath = path('app_movie_show', { id: id }) %}
  {% set mediaLabel = 'Film' %}
{% endif %}

{% set addPath = path('app_media_add_to_default', { kind: kind, id: id }) %}
{% set wishlistPath = path('app_media_add_to_wishlist', { kind: kind, id: id }) %}

{% set tokenId = 'add_media_' ~ kind ~ '_' ~ id %}
{% set wishlistTokenId = 'add_wishlist_' ~ kind ~ '_' ~ id %}

<div class="mt-card mt-media-card h-100 overflow-hidden">

  <a href="{{ showPath }}" class="mt-media-card__thumb">
    {% if imageUrl %}
      <img src="{{ imageUrl }}" class="mt-media-card__img" alt="{{ title }}">
    {% else %}
      <div class="mt-media-card__img-placeholder">
        <div class="text-center px-2">
          <div class="fw-semibold mt-muted">Aucune image</div>
          <div class="small mt-muted">({{ isBook ? 'couverture' : 'affiche' }})</div>
        </div>
      </div>
    {% endif %}
  </a>

  <div class="p-3 d-flex flex-column">

    <span class="badge mt-badge-soft mb-2 align-self-start">{{ mediaLabel }}</span>

    <a href="{{ showPath }}" class="text-decoration-none">
      <div class="fw-semibold mt-text mt-clamp-2">
        {{ title }}
      </div>
    </a>

    <div class="small mt-muted mt-1 mb-3 mt-clamp-2">
      {{ metaLine }}
    </div>

    <div class="mt-auto">
      <div class="d-flex justify-content-center gap-2">

        {% if app.user %}
          {% set inCollection = is_in_collection(kind, id) %}
          {% set inWishlist = is_in_wishlist(kind, id) %}

          {# Bouton collection #}
          {% if inCollection %}
            <span class="btn btn-success btn-sm" title="Deja dans votre collection">
              <i class="bi bi-check-lg"></i>
            </span>
          {% else %}
            <form method="post" action="{{ addPath }}">
              <input type="hidden" name="_token" value="{{ csrf_token(tokenId) }}">
              <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
              <button type="submit" class="btn btn-primary btn-sm" title="Ajouter a ma collection">
                <i class="bi bi-plus-lg"></i>
              </button>
            </form>
          {% endif %}

          {# Bouton wishlist #}
          {% if inWishlist %}
            <span class="btn btn-success btn-sm" title="Deja dans votre liste d'envies">
              <i class="bi bi-heart-fill"></i>
            </span>
          {% else %}
            <form method="post" action="{{ wishlistPath }}">
              <input type="hidden" name="_token" value="{{ csrf_token(wishlistTokenId) }}">
              <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
              <button type="submit" class="btn btn-outline-primary btn-sm" title="Ajouter a ma liste d'envies">
                <i class="bi bi-heart"></i>
              </button>
            </form>
          {% endif %}
        {% else %}
          <a href="{{ path('app_login') }}"
             class="btn btn-primary btn-sm"
             title="Connectez-vous pour ajouter a votre collection">
            <i class="bi bi-plus-lg"></i>
          </a>

          <a href="{{ path('app_login') }}"
             class="btn btn-outline-primary btn-sm"
             title="Connectez-vous pour ajouter a votre liste d'envies">
            <i class="bi bi-heart"></i>
          </a>
        {% endif %}

        <a href="{{ showPath }}" class="btn btn-outline-primary btn-sm" title="Voir les details">
          <i class="bi bi-eye"></i>
        </a>

      </div>
    </div>

  </div>
</div>