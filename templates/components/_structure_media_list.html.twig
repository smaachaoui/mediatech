{% set isBook = (kind == 'book') %}

{% if isBook %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.thumbnail %}
  {% set authors = item.authors ?? [] %}
  {% set authorLine = authors is not empty ? authors|join(', ') : null %}
  {% set year = item.publishedDate ? item.publishedDate|slice(0, 4) : null %}
  {% set description = item.description ?? null %}
  {% set showPath = path('app_book_show', { id: id }) %}
  {% set mediaLabel = 'Livre' %}
{% else %}
  {% set id = item.id %}
  {% set title = item.title %}
  {% set imageUrl = item.poster %}
  {% set authorLine = null %}
  {% set year = item.releaseDate ? item.releaseDate|slice(0, 4) : null %}
  {% set description = item.overview ?? null %}
  {% set showPath = path('app_movie_show', { id: id }) %}
  {% set mediaLabel = 'Film' %}
{% endif %}

{% set addPath = path('app_media_add_to_default', { kind: kind, id: id }) %}
{% set wishlistPath = path('app_media_add_to_wishlist', { kind: kind, id: id }) %}
{% set tokenId = 'add_media_' ~ kind ~ '_' ~ id %}
{% set wishlistTokenId = 'add_wishlist_' ~ kind ~ '_' ~ id %}

<div class="mt-card mt-media-row overflow-hidden">
  <div class="row g-0">

    <div class="col-auto">
      <a href="{{ showPath }}" class="mt-media-row__thumb">
        {% if imageUrl %}
          <img src="{{ imageUrl }}" alt="{{ title }}" class="mt-media-row__img">
        {% else %}
          <div class="mt-media-row__img-placeholder">
            <span class="mt-muted small">?</span>
          </div>
        {% endif %}
      </a>
    </div>

    <div class="col">
      <div class="py-2 px-3 d-flex flex-column h-100">

        <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
          <a href="{{ showPath }}" class="text-decoration-none flex-grow-1">
            <div class="fw-semibold mt-text" style="line-height: 1.3;">
              {{ title }}
            </div>
          </a>
          <span class="badge mt-badge-soft flex-shrink-0">{{ mediaLabel }}</span>
        </div>

        <div class="small mt-muted mb-2">
          {% if authorLine %}
            {{ authorLine }}
            {% if year %} - {{ year }}{% endif %}
          {% elseif year %}
            {{ year }}
          {% else %}
            -
          {% endif %}
        </div>

        {% if description %}
          <div class="small mt-muted mb-2 d-none d-md-block mt-clamp-2">
            {{ description|striptags|slice(0, 150) }}{% if description|length > 150 %}...{% endif %}
          </div>
        {% endif %}

        <div class="mt-auto d-flex flex-wrap gap-2 align-items-center">
          {% if app.user %}
            <form method="post" action="{{ addPath }}" class="d-inline">
              <input type="hidden" name="_token" value="{{ csrf_token(tokenId) }}">
              <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
              <button type="submit" class="btn btn-primary btn-sm">
                + Collection
              </button>
            </form>

            <form method="post" action="{{ wishlistPath }}" class="d-inline">
              <input type="hidden" name="_token" value="{{ csrf_token(wishlistTokenId) }}">
              <input type="hidden" name="redirectTo" value="{{ app.request.uri }}">
              <button type="submit" class="btn btn-outline-primary btn-sm">
                + Envies
              </button>
            </form>
          {% else %}
            <a href="{{ path('app_login') }}"
               class="btn btn-primary btn-sm"
               title="Vous devez etre connecte pour ajouter ce media a votre collection">
              + Collection
            </a>

            <a href="{{ path('app_login') }}"
               class="btn btn-outline-primary btn-sm"
               title="Vous devez etre connecte pour ajouter ce media a votre liste d'envie">
              + Envies
            </a>
          {% endif %}

          <a href="{{ showPath }}" class="btn btn-outline-primary btn-sm">
            Details
          </a>
        </div>

      </div>
    </div>

  </div>
</div>
