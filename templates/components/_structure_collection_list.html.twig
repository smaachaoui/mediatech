{# templates/components/_structure_collection_list.html.twig #}
{# Je recois :
   - collection: App\Entity\Collection
   - context: 'public'|'profile' (optionnel)
   - showOwner: bool (optionnel)
   - showActions: bool (optionnel)
   - showVisibilityBadge: bool (optionnel)
#}

{% set context = context ?? 'public' %}
{% set showOwner = showOwner ?? (context == 'public') %}
{% set showActions = showActions ?? (context == 'profile') %}
{% set showVisibilityBadge = showVisibilityBadge ?? true %}

{% set mediaType = collection.mediaType ?? 'all' %}
{% set showPath = path('app_collection_show', { id: collection.id }) %}

{% set typeLabel = 'Mixte' %}
{% if mediaType == 'book' %}
  {% set typeLabel = 'Livres' %}
{% elseif mediaType == 'movie' %}
  {% set typeLabel = 'Films' %}
{% endif %}

{# Je recupere les couvertures des medias de la collection (max 4) #}
{% set mediaCovers = [] %}

{% for link in collection.collectionBooks|slice(0, 4) %}
  {% if link.book and link.book.coverImage %}
    {% set mediaCovers = mediaCovers|merge([link.book.coverImage]) %}
  {% endif %}
{% endfor %}

{% for link in collection.collectionMovies|slice(0, 4 - mediaCovers|length) %}
  {% if link.movie and link.movie.poster %}
    {% set posterUrl = link.movie.poster %}
    {% if not (posterUrl starts with 'http') %}
      {% set posterUrl = 'https://image.tmdb.org/t/p/w500' ~ posterUrl %}
    {% endif %}
    {% set mediaCovers = mediaCovers|merge([posterUrl]) %}
  {% endif %}
{% endfor %}

{% set coversCount = mediaCovers|length %}
{% set itemsCount = (collection.collectionBooks|length) + (collection.collectionMovies|length) %}

{% set ratingCount = collection.ratings is defined ? (collection.ratings|length) : 0 %}
{% set ratingAvg = null %}
{% if ratingCount > 0 %}
  {% set sum = 0 %}
  {% for r in collection.ratings %}
    {% set sum = sum + (r.value ?? 0) %}
  {% endfor %}
  {% set ratingAvg = (sum / ratingCount) %}
{% endif %}

<div class="card border rounded-3 overflow-hidden">
  <div class="row g-0">

    <div class="col-auto">
      <a href="{{ showPath }}" class="text-decoration-none">
        <div class="collection-list-covers collection-list-covers-{{ coversCount > 4 ? 4 : coversCount }}">
          {% if coversCount > 0 %}
            {% for cover in mediaCovers|slice(0, 4) %}
              <div class="collection-list-cover-item">
                <img src="{{ cover }}" alt="" class="collection-list-cover-img">
              </div>
            {% endfor %}
          {% else %}
            <div class="collection-list-cover-empty d-flex align-items-center justify-content-center">
              <i class="bi bi-collection text-muted"></i>
            </div>
          {% endif %}
        </div>
      </a>
    </div>

    <div class="col">
      <div class="card-body py-2 px-3 d-flex flex-column h-100">

        <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
          <a href="{{ showPath }}" class="text-decoration-none flex-grow-1">
            <div class="fw-semibold text-dark" style="line-height: 1.3;">
              {{ collection.name }}
            </div>
          </a>
          {% if showVisibilityBadge %}
            {% include 'components/_ui_badge_visibility.html.twig' with { collection: collection } %}
          {% endif %}
        </div>

        {% if showOwner and collection.user %}
          <div class="small text-muted">
            Par {{ collection.user.pseudo ?? collection.user.email }}
          </div>
        {% endif %}

        {% if collection.description %}
          <div class="small text-muted mt-1 d-none d-md-block" 
               style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {{ collection.description|striptags|slice(0, 120) }}{% if collection.description|length > 120 %}...{% endif %}
          </div>
        {% endif %}

        <div class="small text-muted mt-2">
          <span class="badge text-bg-light border me-1">{{ typeLabel }}</span>
          <span>{{ itemsCount }} element{{ itemsCount > 1 ? 's' : '' }}</span>
          {% if ratingAvg is not null %}
            <span class="mx-1">&bull;</span>
            <span>{{ ratingAvg|number_format(1, '.', ' ') }}/5 ({{ ratingCount }} avis)</span>
          {% endif %}
        </div>

        <div class="mt-auto d-flex flex-wrap gap-2 align-items-center pt-2">
          <a href="{{ showPath }}" class="btn btn-outline-primary btn-sm">
            Voir la collection
          </a>
        </div>

      </div>
    </div>

  </div>
</div>