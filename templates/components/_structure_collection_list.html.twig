{# templates/components/_structure_collection_list.html.twig #}
{# Je reçois :
   - collection: App\Entity\Collection
   - context: 'public'|'profile' (optionnel)
   - showOwner: bool (optionnel)
   - showActions: bool (optionnel)
   - showVisibilityBadge: bool (optionnel)
#}

{% set context = context ?? 'public' %}
{% set showOwner = showOwner ?? (context == 'public') %}
{% set showActions = showActions ?? (context == 'profile') %}
{% set showVisibilityBadge = showVisibilityBadge ?? true %}

{% set mediaType = collection.mediaType ?? 'all' %}
{% set showPath = path('app_collection_show', { id: collection.id }) %}

{% set typeLabel = 'Mixte' %}
{% if mediaType == 'book' %}
  {% set typeLabel = 'Livres' %}
{% elseif mediaType == 'movie' %}
  {% set typeLabel = 'Films' %}
{% endif %}

{% set coverUrl = null %}

{% if collection.coverImage %}
  {% set coverUrl = collection.coverImage %}
{% endif %}

{% if coverUrl is null %}
  {% if mediaType == 'book' %}
    {% set firstLink = collection.collectionBooks|first %}
    {% if firstLink and firstLink.book and firstLink.book.coverImage %}
      {% set coverUrl = firstLink.book.coverImage %}
    {% endif %}
  {% elseif mediaType == 'movie' %}
    {% set firstLink = collection.collectionMovies|first %}
    {% if firstLink and firstLink.movie and firstLink.movie.poster %}
      {% set coverUrl = firstLink.movie.poster %}
    {% endif %}
  {% else %}
    {% set firstBookLink = collection.collectionBooks|first %}
    {% if firstBookLink and firstBookLink.book and firstBookLink.book.coverImage %}
      {% set coverUrl = firstBookLink.book.coverImage %}
    {% else %}
      {% set firstMovieLink = collection.collectionMovies|first %}
      {% if firstMovieLink and firstMovieLink.movie and firstMovieLink.movie.poster %}
        {% set coverUrl = firstMovieLink.movie.poster %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}

{% set resolvedCoverUrl = null %}
{% if coverUrl %}
  {% if coverUrl starts with 'http' %}
    {% set resolvedCoverUrl = coverUrl %}
  {% else %}
    {% set resolvedCoverUrl = 'https://image.tmdb.org/t/p/w500' ~ coverUrl %}
  {% endif %}
{% endif %}

{% set itemsCount = (collection.collectionBooks|length) + (collection.collectionMovies|length) %}

{% set ratingCount = collection.ratings is defined ? (collection.ratings|length) : 0 %}
{% set ratingAvg = null %}
{% if ratingCount > 0 %}
  {% set sum = 0 %}
  {% for r in collection.ratings %}
    {% set sum = sum + (r.value ?? 0) %}
  {% endfor %}
  {% set ratingAvg = (sum / ratingCount) %}
{% endif %}

<div class="card border rounded-3 overflow-hidden">
  <div class="row g-0">

    <div class="col-auto">
      <a href="{{ showPath }}" class="text-decoration-none">
        {% if resolvedCoverUrl %}
          <img src="{{ resolvedCoverUrl }}" 
               alt="{{ collection.name }}" 
               class="rounded-start"
               style="width: 100px; height: 140px; object-fit: cover;">
        {% else %}
          <div class="d-flex align-items-center justify-content-center bg-light rounded-start" 
               style="width: 100px; height: 140px;">
            <span class="text-muted small">?</span>
          </div>
        {% endif %}
      </a>
    </div>

    <div class="col">
      <div class="card-body py-2 px-3 d-flex flex-column h-100">

        <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
          <a href="{{ showPath }}" class="text-decoration-none flex-grow-1">
            <div class="fw-semibold text-dark" style="line-height: 1.3;">
              {{ collection.name }}
            </div>
          </a>
          {% if showVisibilityBadge %}
            {% include 'components/_ui_badge_visibility.html.twig' with { collection: collection } %}
          {% endif %}
        </div>

        {% if showOwner and collection.user %}
          <div class="small text-muted">
            Par {{ collection.user.pseudo ?? collection.user.email }}
          </div>
        {% endif %}

        {% if collection.description %}
          <div class="small text-muted mt-1 d-none d-md-block" 
               style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {{ collection.description|striptags|slice(0, 120) }}{% if collection.description|length > 120 %}...{% endif %}
          </div>
        {% endif %}

        <div class="small text-muted mt-2">
          <span class="badge text-bg-light border me-1">{{ typeLabel }}</span>
          <span>{{ itemsCount }} élément{{ itemsCount > 1 ? 's' : '' }}</span>
          {% if ratingAvg is not null %}
            <span class="mx-1">&bull;</span>
            <span>{{ ratingAvg|number_format(1, '.', ' ') }}/5 ({{ ratingCount }} avis)</span>
          {% endif %}
        </div>

        <div class="mt-auto d-flex flex-wrap gap-2 align-items-center pt-2">
          <a href="{{ showPath }}" class="btn btn-outline-primary btn-sm">
            Voir la collection
          </a>
        </div>

      </div>
    </div>

  </div>
</div>